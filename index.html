<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warner Media</title>
    <link rel="preconnect" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div id="app">
    <header id="main-header" style="height: 60px; padding: 0 20px; display: flex; align-items: center; justify-content: space-between;">
        <div class="brand">
            <img src="logo.png" alt="Logo" style="height: 15px; width: auto; object-fit: contain;">
        </div>
        <div class="top-icons">
            <i class="fa-solid fa-headset" onclick="showPage('pg-call-center')" style="margin-right: 10px; color: white;"></i>
            <select style="background: none; border: none; color: #fff; font-size: 11px;" onchange="toast('Idioma alterado')">
                <option value="pt">Português</option>
                <option value="en">English</option>
            </select>
        </div>
    </header>

    <div id="pg-lar" class="view">
        <div class="banner-placeholder" style="margin-bottom: 20px;">
            <img src="banner.gif" alt="Banner" style="width: 100%; border-radius: 15px;">
        </div>
        <div class="grid-home">
            <div class="grid-item" onclick="showPage('pg-recarga')"><i class="fa-solid fa-building-columns"></i><span>Recarga</span></div>
            <div class="grid-item" onclick="showPage('pg-retirar')"><i class="fa-solid fa-hand-holding-dollar"></i><span>Retirar</span></div>
            <div class="grid-item" onclick="showPage('pg-equipe')"><i class="fa-solid fa-users"></i><span>Equipe</span></div>
        </div>
        
        <div class="task-card">
            <div class="card-tag">VIP1</div>
            <div class="card-main">
                <div class="card-img"><i class="fa-brands fa-youtube"></i></div>
                <div class="card-details">
                    <div><p class="c-label">Recompensa</p><p class="c-val">250 Kz</p></div>
                    <div><p class="c-label">Tipo</p><p class="c-val">Vídeo</p></div>
                </div>
            </div>
            <button class="btn-action" onclick="completeTask(250)">Ir para tarefa</button>
        </div>
    </div>

    <div id="pg-recarga" class="view page-finance hidden">
        <div class="finance-header" onclick="showPage('pg-lar')"><i class="fa-solid fa-chevron-left"></i> Recarga</div>
        <div class="finance-body">
            <div id="deposito-step-1">
                <div class="input-group">
                    <label>Valor (Mínimo 5.000 Kz)</label>
                    <input type="number" id="deposito-valor" placeholder="5000">
                </div>
                <button class="btn-confirm" onclick="avancarPagamento()">Próximo</button>
            </div>
            <div id="deposito-step-2" class="hidden">
                <div class="admin-card" style="background: #fff; color: #333; padding: 15px; border-radius: 12px;">
                    <p>IBAN: <b id="iban-txt">AO06 0040 0000 1234 5678 9012</b> <i class="fa-solid fa-copy" onclick="copiarIBAN()"></i></p>
                    <p>Valor: <b id="valor-confirmado" style="color: green;"></b></p>
                </div>
                <div class="input-group" style="margin-top: 15px;">
                    <label>Anexar Comprovativo (Nome/Foto)</label>
                    <input type="file" id="comprovativo-img">
                </div>
                <button class="btn-confirm" onclick="finalizarDepositoReal()">Confirmar Envio</button>
                <button class="btn-action" onclick="voltarPasso1()" style="background:gray">Voltar</button>
            </div>
        </div>
    </div>

    <div id="pg-meu" class="view hidden">
        <div class="meu-balance-area">
            <p>Balanço Total</p>
            <h2 class="balance-amount" style="font-size:36px; margin:10px 0;">0 Kz</h2>
            <p>Kwanza (Kz)</p>
        </div>
        <div class="meu-user-stripe">
            <span id="user-email-display">email@carregando...</span>
            <span style="background:var(--accent-green); color:#000; padding:2px 10px; border-radius:15px; font-weight:bold;">VIP 0</span>
        </div>
        <div class="meu-menu-white">
            <div class="meu-menu-row" onclick="showPage('pg-recarga')"><span>Recarregar</span> <i class="fa-solid fa-chevron-right"></i></div>
            <div class="meu-menu-row" onclick="showPage('pg-historico')"><span>Histórico</span> <i class="fa-solid fa-chevron-right"></i></div>
            <div class="meu-menu-row" style="border:none;" onclick="logout()"><span style="color:red;">Sair</span> <i class="fa-solid fa-chevron-right"></i></div>
        </div>
    </div>

    <nav class="bottom-nav">
        <div class="nav-tab active" onclick="showPage('pg-lar', this)"><i class="fa-solid fa-house"></i><span>Lar</span></div>
        <div class="nav-tab" onclick="showPage('pg-vip', this)"><i class="fa-solid fa-crown"></i><span>VIP</span></div>
        <div class="nav-tab" onclick="showPage('pg-meu', this)"><i class="fa-solid fa-user"></i><span>Meu</span></div>
    </nav>
</div>

<script>
const API_URL = "https://warnermida-1.onrender.com";

// --- INICIALIZAÇÃO ---
window.onload = () => {
    const user = JSON.parse(localStorage.getItem('usuario'));
    if (!user) {
        window.location.href = 'login.html';
        return;
    }
    document.getElementById('user-email-display').innerText = user.email;
    sincronizarDados(); // Busca saldo real do banco
};

// --- SINCRONIZAÇÃO ---
async function sincronizarDados() {
    const user = JSON.parse(localStorage.getItem('usuario'));
    try {
        const res = await fetch(`${API_URL}/api/usuario/${user.id}`);
        if (res.ok) {
            const dadosNovos = await res.json();
            localStorage.setItem('usuario', JSON.stringify(dadosNovos));
            document.querySelectorAll('.balance-amount').forEach(el => {
                el.innerText = `${dadosNovos.saldo} Kz`;
            });
        }
    } catch (err) { console.error("Erro sincronia"); }
}

// --- NAVEGAÇÃO ---
function showPage(id, el) {
    document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
    const target = document.getElementById(id);
    if(target) target.classList.remove('hidden');

    if(el) {
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        el.classList.add('active');
    }
}

// --- DEPÓSITO REAL ---
function avancarPagamento() {
    const val = document.getElementById('deposito-valor').value;
    if (val < 5000) return toast("Mínimo 5.000 Kz");
    document.getElementById('valor-confirmado').innerText = val + " Kz";
    document.getElementById('deposito-step-1').classList.add('hidden');
    document.getElementById('deposito-step-2').classList.remove('hidden');
}

function voltarPasso1() {
    document.getElementById('deposito-step-2').classList.add('hidden');
    document.getElementById('deposito-step-1').classList.remove('hidden');
}

async function finalizarDepositoReal() {
    const user = JSON.parse(localStorage.getItem('usuario'));
    const valor = document.getElementById('deposito-valor').value;
    const file = document.getElementById('comprovativo-img').value;

    if (!file) return toast("Anexe o comprovativo!");

    try {
        const res = await fetch(`${API_URL}/api/deposito`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ usuario_id: user.id, valor, comprovativo: "Imagem enviada" })
        });
        if (res.ok) {
            toast("Enviado para análise do Admin!");
            showPage('pg-lar');
        }
    } catch (err) { toast("Erro ao enviar"); }
}

// --- UTILITÁRIOS ---
function toast(msg) {
    const t = document.createElement('div');
    t.style = "position:fixed; bottom:100px; left:50%; transform:translateX(-50%); background:black; color:white; padding:10px 20px; border-radius:20px; z-index:10000;";
    t.innerText = msg;
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 2500);
}

function logout() {
    localStorage.removeItem('usuario');
    window.location.href = 'login.html';
}

function copiarIBAN() {
    navigator.clipboard.writeText("AO0600400000123456789012");
    toast("IBAN Copiado!");
}
</script>
</body>
</html>
