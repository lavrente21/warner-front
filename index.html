<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8"> 
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Warner Media</title>
<link rel="preconnect" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<link rel="stylesheet" href="style.css">
    <script src="https://quge5.com/88/tag.min.js" data-zone="203025" async data-cfasync="false"></script>
</head>
<body>

<div id="app">
<header id="main-header" style="height: 60px; padding: 0 20px; display: flex; align-items: center; justify-content: space-between;">
    <div class="brand" style="display: flex; align-items: center; height: 100%;">
        <img src="logo.png" alt="Logo" style="height: 15px; width: auto; border-radius: 0; object-fit: contain;">
    </div>
    <div class="top-icons" style="display: flex; align-items: center;">
        <i class="fa-solid fa-headset" onclick="showPage('pg-call-center')" style="margin-right: 10px; color: white; cursor: pointer;"></i>
        <div class="lang-selector">
            <select style="background: none; border: none; color: #fff; font-size: 11px;" onchange="changeLanguage(this.value)">
                <option value="pt">Português</option>
                <option value="en">English</option>
            </select>
        </div>
    </div>
</header>

<div id="pg-lar" class="view">
    <div class="ad-notice" style="background: rgba(255, 255, 255, 0.05); border: 1px dashed rgba(255, 255, 255, 0.2); margin: 15px; padding: 12px; border-radius: 12px; text-align: center;">
    <p style="color: #00ff88; font-size: 11px; font-weight: 600; margin-bottom: 5px;">
        <i class="fa-solid fa-circle-info"></i> NOTA SOBRE ANÚNCIOS
    </p>
    <p style="color: #eee; font-size: 10px; line-height: 1.4; opacity: 0.8;">
        Os anúncios exibidos ajudam a financiar as recompensas dos usuários. 
        Se abrir uma janela, <b>aguarde e volte para o site </b> para confirmar seu ganho  <div class="banner-placeholder" style="background: none;">
        
        <img src="banner.gif" alt="Banner" style="width: 100%; height: 100%; border-radius: 15px; object-fit: cover;">
    </div>
<div class="grid-home">
    <div class="grid-item" onclick="showPage('pg-recarga')">
        <i class="fa-solid fa-building-columns"></i>
        <span>Recarga</span>
    </div>

    <div class="grid-item" onclick="showPage('pg-retirar')">
        <i class="fa-solid fa-hand-holding-dollar"></i>
        <span>Retirar</span>
    </div>

    <div class="grid-item" onclick="showPage('pg-equipe')">
        <i class="fa-solid fa-users"></i>
        <span>Equipe</span>
    </div>
</div>
<div class="task-card">
    <div class="card-tag">VIP1</div>
    <div class="card-main">
        <div class="card-img"><i class="fa-brands fa-youtube"></i></div>
        <div class="card-details">
            <div><p class="c-label">Recompensa</p><p class="c-val">250 Kz</p></div>
            <div><p class="c-label">Tipo</p><p class="c-val">Vídeo</p></div>
        </div>
    </div>
    <button class="btn-action" onclick="completeTask(250)">Ir para tarefa</button>
</div>

<div class="task-card">
    <div class="card-tag">VIP2</div>
    <div class="card-main">
        <div class="card-img"><i class="fa-brands fa-youtube"></i></div>
        <div class="card-details">
            <div><p class="c-label">Recompensa</p><p class="c-val">500 Kz</p></div>
            <div><p class="c-label">Tipo</p><p class="c-val">Vídeo</p></div>
        </div>
    </div>
    <button class="btn-action" onclick="completeTask(500)">Ir para tarefa</button>
</div>

<div class="task-card">
    <div class="card-tag">VIP3</div>
    <div class="card-main">
        <div class="card-img"><i class="fa-brands fa-youtube"></i></div>
        <div class="card-details">
            <div><p class="c-label">Recompensa</p><p class="c-val">1000 Kz</p></div>
            <div><p class="c-label">Tipo</p><p class="c-val">Vídeo</p></div>
        </div>
    </div>
    <button class="btn-action" onclick="completeTask(1000)">Ir para tarefa</button>
</div>
</div>


<div id="pg-tarefa" class="view hidden">
    <div class="task-tabs">
        <button class="task-tab-btn active" onclick="showTarefas('nao-concluidas')">Não concluído</button>
        <button class="task-tab-btn" onclick="showTarefas('concluidas')">Concluído</button>
    </div>
    <div id="tarefas-nao-concluidas">
        <div class="task-card">
            <div class="card-tag">VIP1</div>
            <div class="card-main">
                <div class="card-img"><i class="fa-brands fa-youtube"></i></div>
                <div class="card-details">
                    <div><p class="c-label">Recompensa</p><p class="c-val">250 Kz</p></div>
                    <div><p class="c-label">Tipo</p><p class="c-val">Vídeo</p></div>
                </div>
            </div>
<button class="btn-action" onclick="completeTask(250, this)">Ir para tarefa</button>        </div>
    </div>
    <div id="tarefas-concluidas" class="hidden">
        <p style="text-align: center; padding: 20px; color: #fff;">Nenhuma tarefa concluída.</p>
    </div>
</div>

<div id="pg-call-center" class="view page-finance hidden">
    <div class="finance-header" onclick="showPage('pg-lar')"><i class="fa-solid fa-chevron-left"></i> Suporte</div>
    <div class="finance-body">
        <div class="chat-container" style="background: #fff; border-radius: 12px; display: flex; flex-direction: column; height: 70vh;">
            <div class="chat-messages" id="chat-messages" style="flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px;">
                <p style="text-align: center; color: #888; font-size: 11px;">Olá! Como podemos ajudar hoje?</p>
            </div>
          <div class="chat-input" style="display: flex; gap: 10px; flex-wrap: wrap;">
    <input type="text" id="mensagem-suporte" placeholder="Mensagem..." style="flex: 1; padding: 10px; border-radius: 8px;">
    
    <label for="suporte-img" style="background: #555; color: white; padding: 10px; border-radius: 8px; cursor: pointer;">
        <i class="fa-solid fa-camera"></i>
    </label>
    <input type="file" id="suporte-img" accept="image/*" style="display: none;" onchange="enviarImagemSuporte(this)">
    
    <button class="btn-send" onclick="enviarMensagemSuporte()" style="background: #6a3ab2; color: white; border: none; padding: 10px 15px; border-radius: 8px;">
        <i class="fa-solid fa-paper-plane"></i>
    </button>
</div>
        </div>
    </div>
</div>

<div id="pg-equipe" class="view hidden">
    <div class="finance-header" onclick="showPage('pg-lar')">
        <i class="fa-solid fa-chevron-left"></i> Minha Equipa
    </div>
    <div class="finance-body">
        <div class="admin-card" style="background: linear-gradient(135deg, #6a3ab2, #a83279); color: white; padding: 20px; border-radius: 15px; text-align: center;">
            <i class="fa-solid fa-share-nodes" style="font-size: 30px; margin-bottom: 10px;"></i>
            <h3>Convide Amigos</h3>
            <p style="font-size: 12px; opacity: 0.9; margin-bottom: 15px;">Ganhe até 15% de comissão sobre os investimentos dos seus amigos.</p>
            
            <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                <span id="link-convite" style="font-size: 11px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-right: 10px;">https://picadji.com/reg?ref=user7721</span>
                <button onclick="copiarLink()" style="background: white; color: #6a3ab2; border: none; padding: 5px 10px; border-radius: 5px; font-weight: bold; cursor: pointer;">COPIAR</button>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px;">
            <div style="background: #fff; color: #333; padding: 15px; border-radius: 12px; text-align: center;">
                <small>Total de Amigos</small>
                <h4 id="team-size-val" style="font-size: 20px;">0</h4>
            </div>
            <div style="background: #fff; color: #333; padding: 15px; border-radius: 12px; text-align: center;">
                <small>Bónus Ganho</small>
                <h4 id="team-bonus-val" style="font-size: 20px; color: green;">0 Kz</h4>
            </div>
        </div>

        <div style="margin-top: 20px;">
            <p style="font-size: 13px; margin-bottom: 10px; color: #333;">Regras de Recompensa:</p>
            <div style="background: rgba(255,255,255,0.8); padding: 10px; border-radius: 10px; font-size: 12px; color: #333;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span>Nível 1 (Diretos)</span> <b>10%</b>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span>Nível 2</span> <b>3%</b>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>Nível 3</span> <b>2%</b>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="pg-vip" class="view hidden">
    <h2 style="text-align:center; color:white; margin:20px 0; font-size: 18px;">Planos VIP</h2>
    <div id="container-vips-lista">
        <p style="text-align:center; color:gray;">Carregando planos...</p>
    </div>
</div>

    
<div id="pg-meu" class="view hidden">
    <div class="meu-balance-area">
        <p style="font-size:12px; opacity:0.8;">Balanço Total</p>
        <h2 id="user-balance" class="balance-amount" style="font-size:36px; margin:10px 0;">0</h2>
        <p style="font-size:12px;">Kwanza (Kz)</p>
    </div>

 <div class="meu-user-stripe">
    <span id="user-name">Carregando...</span>
    <span id="user-vip" style="background:var(--accent-green); color:#000; padding:2px 10px; border-radius:15px; font-weight:bold;">VIP 0</span>
</div>

    <div class="meu-menu-white">
        <div class="meu-menu-row" onclick="showPage('pg-recarga')"><span>Recarregar</span> <i class="fa-solid fa-chevron-right"></i></div>
        <div class="meu-menu-row" onclick="showPage('pg-retirar')"><span>Retirar</span> <i class="fa-solid fa-chevron-right"></i></div>
        
        <div class="meu-menu-row" onclick="showPage('pg-historico')">
            <span style="font-weight:bold;"><i class="fa-solid fa-clock-rotate-left"></i> Histórico de Transações</span> 
            <i class="fa-solid fa-chevron-right"></i>
        </div>

        <div class="meu-menu-row" onclick="showPage('pg-equipe')"><span>Minha Equipe</span> <i class="fa-solid fa-chevron-right"></i></div>
        <div class="meu-menu-row" onclick="showPage('pg-senha')"><span>Alterar Senha</span> <i class="fa-solid fa-chevron-right"></i></div>
        <div class="meu-menu-row" style="border:none;" onclick="logout()"><span style="color:red;">Sair</span> <i class="fa-solid fa-chevron-right"></i></div>
    </div>
</div>

<div id="pg-retirar" class="view page-finance hidden">
    <div class="finance-header" onclick="showPage('pg-lar')">
        <i class="fa-solid fa-chevron-left"></i> Levantamento
    </div>
    <div class="finance-body">
        <div class="input-group">
            <label>Valor (Kz)</label>
            <input type="number" placeholder="Mínimo 5.000" id="valor-retirada">
        </div>
        <div class="input-group">
            <label>IBAN</label>
            <input type="text" placeholder="AO06..." id="iban-retirada">
        </div>
        <div class="input-group">
            <label>Nome do Titular</label>
            <input type="text" placeholder="Nome completo" id="nome-retirada">
        </div>
        <div class="input-group">
            <label>Senha</label>
            <input type="password" placeholder="Senha" id="senha-retirada">
        </div>
        <button class="btn-confirm" onclick="confirmarRetirada()">
            <i class="fa-solid fa-money-bill-transfer"></i> Confirmar Levantamento
        </button>
    </div>
</div>
    
<div id="pg-historico" class="view page-finance hidden">
    <div class="finance-header" onclick="showPage('pg-meu')">
        <i class="fa-solid fa-chevron-left"></i> Voltar ao Meu Perfil
    </div>
    <div class="finance-body">
        <h3 style="margin-bottom: 15px; font-size: 14px; opacity: 0.7;">Registo de Atividades</h3>
        <div id="lista-transacoes">
            <div class="transaction-card" style="background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 10px; border-left: 5px solid #f1c40f; color: #333;">
                <div style="display: flex; justify-content: space-between;">
                    <span style="font-size: 12px;">Depósito via IBAN</span>
                    <b style="color: #f1c40f; font-size: 10px;">PENDENTE</b>
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                    <b style="font-size: 16px;">+ 10.000 Kz</b>
                    <span style="font-size: 11px; opacity: 0.5;">11/01/2026</span>
                </div>
            </div>
        </div>
    </div>
</div>
    
<div id="pg-recarga" class="view page-finance hidden">
    <div class="finance-header" onclick="showPage('pg-lar')">
        <i class="fa-solid fa-chevron-left"></i> Recarga de Saldo
    </div>
    
    <div class="finance-body">
        <div id="deposito-step-1">
            <div class="input-group">
                <label>Valor a depositar (Kz)</label>
                <input type="number" id="deposito-valor" placeholder="Mínimo 5.000 Kz">
            </div>

            <div class="input-group">
                <label>Selecione o seu Banco</label>
                <select id="deposito-banco" style="width: 100%; padding: 12px; border-radius: 8px; background: #fff; color: #333;">
                    <option value="BAI">BAI (Transferência/Depósito)</option>
                    <option value="BFA">BFA</option>
                    <option value="Unitel Money">Unitel Money</option>
                </select>
            </div>

            <button class="btn-confirm" onclick="avancarPagamento()">Próximo <i class="fa-solid fa-arrow-right"></i></button>
        </div>

        <div id="deposito-step-2" class="hidden">
            <div class="admin-card" style="background: #fff; color: #333; padding: 15px; border-radius: 12px;">
                <p style="font-size: 12px; font-weight: bold; color: var(--primary-purple);">Dados para Pagamento:</p>
                
                <div style="background: #f4f4f4; padding: 10px; border-radius: 8px; margin: 10px 0; display: flex; justify-content: space-between; align-items: center;">
                    <span id="iban-txt" style="font-size: 13px; font-weight: bold;">AO06 0040 0000 1234 5678 9012</span>
                    <i class="fa-solid fa-copy" onclick="copiarIBAN()" style="color: var(--primary-purple); cursor: pointer; padding: 5px;"></i>
                </div>

                <p style="font-size: 11px;">Beneficiário: <b>PicaDji Angola</b></p>
                <p style="font-size: 11px;">Valor a enviar: <b id="valor-confirmado" style="color: green;"></b></p>
            </div>

            <div class="input-group" style="margin-top: 20px;">
                <label>Anexe a Foto do Comprovativo</label>
                <input type="file" id="comprovativo-img" accept="image/*" style="background: #fff; color: #333; width: 100%; border-radius: 8px; padding: 8px;">
            </div>

            <button class="btn-confirm" onclick="finalizarDeposito()">Confirmar Envio</button>
            <button class="btn-action" style="background: none; border: 1px solid #555; color: #fff; margin-top: 10px;" onclick="voltarPasso1()">Voltar</button>
        </div>
    </div>
</div>

<div id="pg-deposito-coordenadas" class="view page-finance hidden">
    <div class="finance-header" onclick="showPage('pg-lar')"><i class="fa-solid fa-chevron-left"></i> Depósito</div>
    <div class="finance-body">
        <div class="input-group">
            <label>Valor a depositar</label>
            <input type="text" id="valor-deposito-coordenadas" disabled>
        </div>
        <div class="input-group">
            <label>Coordenadas de depósito</label>
            <div class="code-display" style="background: #fff; padding: 10px; border-radius: 8px; margin-bottom: 5px; color: #333;">
                <span>Banco: Banco Atlântico</span>
            </div>
            <div class="code-display" style="background: #fff; padding: 10px; border-radius: 8px; margin-bottom: 5px; color: #333;">
                <span>IBAN: AO06 0040 0000 1234 5678 9012</span>
            </div>
            <div class="code-display" style="background: #fff; padding: 10px; border-radius: 8px; margin-bottom: 5px; color: #333;">
                <span>Titular: ZEROmallS</span>
            </div>
        </div>
        <button class="btn-confirm" onclick="toast('Depósito em análise!')">Confirmar Depósito</button>
    </div>
</div>

<div id="pg-senha" class="view page-finance hidden">
    <div class="finance-header" onclick="showPage('pg-meu')"><i class="fa-solid fa-chevron-left"></i> Alterar Senha</div>
    <div class="finance-body">
        <div class="input-group"><label>Senha Atual</label><input type="password"></div>
        <div class="input-group"><label>Nova Senha</label><input type="password"></div>
        <button class="btn-confirm" onclick="toast('Senha alterada!')">Atualizar</button>
    </div>
</div>

<nav class="bottom-nav">
<div class="nav-tab active" onclick="showPage('pg-lar', this)"><i class="fa-solid fa-house"></i><span>Lar</span></div>
<div class="nav-tab" onclick="showPage('pg-tarefa', this)"><i class="fa-solid fa-list-check"></i><span>Tarefa</span></div>
<div class="nav-tab" onclick="showPage('pg-equipe', this)"><i class="fa-solid fa-users"></i><span>Equipe</span></div>
<div class="nav-tab" onclick="showPage('pg-vip', this)"><i class="fa-solid fa-crown"></i><span>VIP</span></div>
<div class="nav-tab" onclick="showPage('pg-meu', this)"><i class="fa-solid fa-user"></i><span>Meu</span></div>
</nav>
</div>

    <script>
const API_URL = "https://warnermida-1.onrender.com";
const IMGBB_KEY = "f1cbde38d1820926fd47faeb3e74975f";

// --- GESTÃO DE NAVEGAÇÃO E ANÚNCIOS ---
function showPage(id, el) {
    document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
    const target = document.getElementById(id);
    if(target) target.classList.remove('hidden');

    const header = document.getElementById('main-header');
    const mains = ['pg-lar', 'pg-tarefa', 'pg-meu', 'pg-vip', 'pg-equipe'];
    if(header) header.style.display = mains.includes(id) ? 'flex' : 'none';

    if(el) {
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        el.classList.add('active');
    }
    window.scrollTo(0,0);
    
    // Removido sistema de injeção de script de anúncios globais para evitar bloqueios
    if(id === 'pg-equipe') sincronizarDados();
    if(id === 'pg-vip') carregarPlanosVIP();
    if(id === 'pg-call-center') {
        carregarHistoricoSuporte();
        window.chatInterval = setInterval(carregarHistoricoSuporte, 5000);
    } else {
        if(window.chatInterval) clearInterval(window.chatInterval);
    }
}
// --- CONTROLE DAS ABAS DE TAREFAS (CORREÇÃO DO ERRO) ---
function showTarefas(aba) {
    const naoConcluidas = document.getElementById('tarefas-nao-concluidas');
    const concluidas = document.getElementById('tarefas-concluidas');
    const btns = document.querySelectorAll('.task-tab-btn');

    btns.forEach(b => b.classList.remove('active'));
    
    if (aba === 'concluidas') {
        naoConcluidas.classList.add('hidden');
        concluidas.classList.remove('hidden');
        btns[1].classList.add('active');
    } else {
        naoConcluidas.classList.remove('hidden');
        concluidas.classList.add('hidden');
        btns[0].classList.add('active');
    }
}

// --- FUNÇÃO DE TAREFA COM ANÚNCIO ---
// --- FUNÇÃO DE TAREFA COM ANÚNCIO CORRIGIDA ---
async function completeTask(val, buttonEl) {
    if (!buttonEl) return;

    const user = JSON.parse(localStorage.getItem('user') || localStorage.getItem('usuario'));
    if (!user) return toast("Faça login");

    // O SEU LINK DIRECTO MONETAG/PROPELLER
    const adURL = "https://otieu.com/4/10478792";

    // 1. Prepara o botão para o clique obrigatório
    buttonEl.innerText = "ABRIR TAREFA (ANÚNCIO)";
    buttonEl.style.background = "#e67e22"; 

    buttonEl.onclick = () => {
        // 2. Abre a aba do anúncio diretamente
        const win = window.open(adURL, '_blank');
        
        if (!win) {
            toast("⚠️ Ative os Pop-ups para abrir a tarefa!");
            return;
        }

        toast("Aguarde 5 segundos na página da tarefa...");
        buttonEl.innerText = "⏳ Verificando...";
        buttonEl.disabled = true;

        // 3. Temporizador de 5 segundos para libertar o pagamento
        setTimeout(() => {
            buttonEl.innerText = "CONFIRMAR E RECEBER";
            buttonEl.disabled = false;
            buttonEl.style.background = "#27ae60";

            buttonEl.onclick = async () => {
                buttonEl.disabled = true;
                buttonEl.innerText = "A processar...";
                
                try {
                    const res = await fetch(`${API_URL}/api/completar-tarefa`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ usuario_id: user.id || user._id, valor: val })
                    });

                    if (res.ok) {
                        toast(`✅ +${val} Kz creditados!`);
                        sincronizarDados();
                        buttonEl.innerText = "CONCLUÍDO";
                        buttonEl.style.background = "#ccc";
                    } else {
                        toast("Erro ao validar.");
                        buttonEl.disabled = false;
                        buttonEl.innerText = "TENTAR NOVAMENTE";
                    }
                } catch (e) {
                    toast("Erro de ligação.");
                    buttonEl.disabled = false;
                }
            };
        }, 5000);
    };
}
        
        // --- SUPORTE E IMAGENS ---
async function enviarImagemSuporte(input) {
    if (!input.files || !input.files[0]) return;
    const user = JSON.parse(localStorage.getItem('user') || localStorage.getItem('usuario'));
    
    toast("Enviando foto...");
    const formData = new FormData();
    formData.append("image", input.files[0]);

    try {
        const resImg = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, { method: "POST", body: formData });
        const dataImg = await resImg.json();

        if (dataImg.success) {
            await fetch(`${API_URL}/api/suporte/enviar`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    usuario_id: user.id || user._id, 
                    enviado_por: 'usuario', 
                    mensagem: `<img src="${dataImg.data.url}" style="max-width:200px; border-radius:10px;">` 
                })
            });
            carregarHistoricoSuporte();
        }
    } catch (err) { toast("Erro ao enviar foto."); }
}

async function carregarHistoricoSuporte() {
    const storageData = localStorage.getItem('user') || localStorage.getItem('usuario');
    if(!storageData) return;
    const user = JSON.parse(storageData);
    const userId = user.id || user._id;

    try {
        const res = await fetch(`${API_URL}/api/suporte/historico/${userId}`);
        const mensagens = await res.json();
        const box = document.getElementById('chat-messages');
        if(!box) return;
        box.innerHTML = "";

        mensagens.forEach(m => {
            const isMe = m.enviado_por === 'usuario';
            const align = isMe ? 'flex-end' : 'flex-start';
            const bg = isMe ? '#6a3ab2' : '#f1f1f1';
            const color = isMe ? '#fff' : '#333';
            const radius = isMe ? '12px 12px 0 12px' : '12px 12px 12px 0';

            box.innerHTML += `
                <div style="align-self: ${align}; background: ${bg}; color: ${color}; padding: 10px 15px; border-radius: ${radius}; max-width: 80%; font-size: 13px; margin-bottom: 8px;">
                    ${m.mensagem}
                </div>`;
        });
        box.scrollTop = box.scrollHeight;
    } catch (err) { console.error("Erro no chat"); }
}

async function enviarMensagemSuporte() {
    const input = document.getElementById('mensagem-suporte');
    const msg = input.value.trim();
    const user = JSON.parse(localStorage.getItem('user') || localStorage.getItem('usuario'));
    if (!msg) return;

    try {
        const res = await fetch(`${API_URL}/api/suporte/enviar`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ usuario_id: user.id || user._id, enviado_por: 'usuario', mensagem: msg })
        });
        if (res.ok) { input.value = ""; carregarHistoricoSuporte(); }
    } catch (err) { toast("Erro ao enviar."); }
}

// --- SISTEMA DE DADOS E VIP ---
async function sincronizarDados() {
    try {
        const storageData = localStorage.getItem('user') || localStorage.getItem('usuario');
        if (!storageData) return;
        const user = JSON.parse(storageData);
        const userId = user.id || user._id;

        const resUser = await fetch(`${API_URL}/api/usuario/${userId}`);
        if (resUser.ok) {
            const dadosNovos = await resUser.json();
            localStorage.setItem('usuario', JSON.stringify(dadosNovos));
            
            if(document.getElementById('user-balance')) document.getElementById('user-balance').innerText = `${dadosNovos.saldo} Kz`;
            if(document.getElementById('user-name')) document.getElementById('user-name').innerText = dadosNovos.nome;
            
            const vipBadge = document.getElementById('user-vip');
            if(vipBadge) {
                const nivel = dadosNovos.nivel_vip || 0;
                vipBadge.innerText = `VIP ${nivel}`;
                vipBadge.style.background = nivel > 0 ? "gold" : "#00ff88";
            }

            const linkEl = document.getElementById('link-convite');
            if (linkEl && dadosNovos.referral_id) {
                linkEl.innerText = `https://warnermidia.netlify.app/registro.html?ref=${dadosNovos.referral_id}`;
            }
        }
    } catch (err) { console.error("Erro ao sincronizar"); }
}

async function carregarPlanosVIP() {
    try {
        const res = await fetch(`${API_URL}/api/vips`);
        const planos = await res.json();
        const container = document.getElementById('container-vips-lista');
        if(!container) return;
        container.innerHTML = "";

        planos.forEach(p => {
            container.innerHTML += `
                <div class="vip-card" style="margin-bottom: 20px;">
                    <div class="card-tag" style="background: gold; color: black;">${p.nome}</div>
                    <div class="card-main" style="flex-direction: column; align-items: flex-start; padding: 15px;">
                        <div style="display: flex; justify-content: space-between; width: 100%; margin-bottom: 10px;">
                            <span style="color: #eee;">Preço:</span>
                            <b style="color: #fff;">${p.preco} Kz</b>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; font-size: 12px;">
                            <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 5px;">Nível ${p.nivel}</div>
                            <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 5px;">${p.qtd_tarefas} Tarefas</div>
                        </div>
                    </div>
                    <button class="btn-action" onclick="comprarVIP(${p.nivel}, ${p.preco})" style="width: 100%; border-radius: 0 0 12px 12px;">Desbloquear</button>
                </div>`;
        });
    } catch (err) { console.error("Erro VIPs"); }
}

async function comprarVIP(nivel, preco) {
    const user = JSON.parse(localStorage.getItem('user') || localStorage.getItem('usuario'));
    toast("Processando...");
    try {
        const res = await fetch(`${API_URL}/api/comprar-vip`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ usuario_id: user.id || user._id, nivel_vip: nivel, valor_pago: preco })
        });
        const data = await res.json();
        if (!res.ok) return toast("❌ " + (data.error || "Erro"));
        toast(`✅ VIP ${nivel} Ativado!`);
        sincronizarDados();
    } catch (err) { toast("Erro de conexão"); }
}

// --- FINANCEIRO ---
async function confirmarRetirada() {
    const valor = document.getElementById('valor-retirada').value;
    const iban = document.getElementById('iban-retirada').value;
    const titular = document.getElementById('nome-retirada').value;
    const senha = document.getElementById('senha-retirada').value;
    const user = JSON.parse(localStorage.getItem('user') || localStorage.getItem('usuario'));

    if (valor < 5000) return toast("Mínimo 5.000 Kz");
    toast("Processando...");

    try {
        const res = await fetch(`${API_URL}/api/levantamento`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ usuario_id: user.id || user._id, valor: parseFloat(valor), iban, nome_titular: titular, senha })
        });
        const data = await res.json();
        if (!res.ok) return toast("❌ " + (data.error || "Erro"));
        toast("✅ Pedido enviado!");
        sincronizarDados();
        setTimeout(() => showPage('pg-lar'), 2000);
    } catch (err) { toast("Erro de conexão"); }
}

async function finalizarDeposito() {
    const valorInput = document.getElementById('deposito-valor');
    const imgInput = document.getElementById('comprovativo-img');
    const user = JSON.parse(localStorage.getItem('user') || localStorage.getItem('usuario'));

    if (!imgInput.files[0] || valorInput.value < 5000) return toast("Dados incompletos");

    toast("Hospedando imagem...");
    const formData = new FormData();
    formData.append("image", imgInput.files[0]);

    try {
        const resImg = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, { method: "POST", body: formData });
        const dataImg = await resImg.json();

        if (dataImg.success) {
            await fetch(`${API_URL}/api/deposito`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ usuario_id: user.id || user._id, valor: valorInput.value, comprovativo: dataImg.data.url })
            });
            toast("✅ Enviado para análise!");
            showPage('pg-lar');
        }
    } catch (err) { toast("Erro de conexão"); }
}

// --- UTILITÁRIOS ---
function toast(msg) {
    const t = document.createElement('div');
    t.style = "position:fixed; bottom:100px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.85); color:#fff; padding:12px 20px; border-radius:25px; font-size:12px; z-index:9999; text-align:center; min-width:200px;";
    t.innerText = msg;
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 2500);
}

function logout() { localStorage.clear(); window.location.href = 'login.html'; }
function copiarIBAN() { navigator.clipboard.writeText(document.getElementById('iban-txt').innerText); toast("IBAN copiado!"); }
function copiarLink() { navigator.clipboard.writeText(document.getElementById('link-convite').innerText); toast("Link copiado!"); }

function avancarPagamento() {
    const v = document.getElementById('deposito-valor').value;
    if (v < 5000) return toast("Mínimo 5.000 Kz");
    document.getElementById('valor-confirmado').innerText = v + " Kz";
    document.getElementById('deposito-step-1').classList.add('hidden');
    document.getElementById('deposito-step-2').classList.remove('hidden');
}

function voltarPasso1() {
    document.getElementById('deposito-step-2').classList.add('hidden');
    document.getElementById('deposito-step-1').classList.remove('hidden');
}

window.addEventListener('load', () => {
    if (!(localStorage.getItem('user') || localStorage.getItem('usuario'))) {
        window.location.href = 'login.html';
    } else {
        sincronizarDados();
    }
});
</script>
</body>
                </html>
