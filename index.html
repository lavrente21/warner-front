<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Warner Media</title>
<link rel="preconnect" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<link rel="stylesheet" href="style.css">
</head>
<body>

<div id="app">
<header id="main-header" style="height: 60px; padding: 0 20px; display: flex; align-items: center; justify-content: space-between;">
    <div class="brand" style="display: flex; align-items: center; height: 100%;">
        <img src="logo.png" alt="Logo" style="height: 15px; width: auto; border-radius: 0; object-fit: contain;">
    </div>
    <div class="top-icons" style="display: flex; align-items: center;">
        <i class="fa-solid fa-headset" onclick="showPage('pg-call-center')" style="margin-right: 10px; color: white; cursor: pointer;"></i>
        <div class="lang-selector">
            <select style="background: none; border: none; color: #fff; font-size: 11px;" onchange="changeLanguage(this.value)">
                <option value="pt">Português</option>
                <option value="en">English</option>
            </select>
        </div>
    </div>
</header>

<div id="pg-lar" class="view">
    <div class="banner-placeholder" style="background: none;">
        <img src="banner.gif" alt="Banner" style="width: 100%; height: 100%; border-radius: 15px; object-fit: cover;">
    </div>
<div class="grid-home">
    <div class="grid-item" onclick="showPage('pg-recarga')">
        <i class="fa-solid fa-building-columns"></i>
        <span>Recarga</span>
    </div>

    <div class="grid-item" onclick="showPage('pg-retirar')">
        <i class="fa-solid fa-hand-holding-dollar"></i>
        <span>Retirar</span>
    </div>

    <div class="grid-item" onclick="showPage('pg-equipe')">
        <i class="fa-solid fa-users"></i>
        <span>Equipe</span>
    </div>
</div>
<div class="task-card">
    <div class="card-tag">VIP1</div>
    <div class="card-main">
        <div class="card-img"><i class="fa-brands fa-youtube"></i></div>
        <div class="card-details">
            <div><p class="c-label">Recompensa</p><p class="c-val">250 Kz</p></div>
            <div><p class="c-label">Tipo</p><p class="c-val">Vídeo</p></div>
        </div>
    </div>
    <button class="btn-action" onclick="completeTask(250)">Ir para tarefa</button>
</div>

<div class="task-card">
    <div class="card-tag">VIP2</div>
    <div class="card-main">
        <div class="card-img"><i class="fa-brands fa-youtube"></i></div>
        <div class="card-details">
            <div><p class="c-label">Recompensa</p><p class="c-val">500 Kz</p></div>
            <div><p class="c-label">Tipo</p><p class="c-val">Vídeo</p></div>
        </div>
    </div>
    <button class="btn-action" onclick="completeTask(500)">Ir para tarefa</button>
</div>

<div class="task-card">
    <div class="card-tag">VIP3</div>
    <div class="card-main">
        <div class="card-img"><i class="fa-brands fa-youtube"></i></div>
        <div class="card-details">
            <div><p class="c-label">Recompensa</p><p class="c-val">1000 Kz</p></div>
            <div><p class="c-label">Tipo</p><p class="c-val">Vídeo</p></div>
        </div>
    </div>
    <button class="btn-action" onclick="completeTask(1000)">Ir para tarefa</button>
</div>
</div>


<div id="pg-tarefa" class="view hidden">
    <div class="task-tabs">
        <button class="task-tab-btn active" onclick="showTarefas('nao-concluidas')">Não concluído</button>
        <button class="task-tab-btn" onclick="showTarefas('concluidas')">Concluído</button>
    </div>
    <div id="tarefas-nao-concluidas">
        <div class="task-card">
            <div class="card-tag">VIP1</div>
            <div class="card-main">
                <div class="card-img"><i class="fa-brands fa-youtube"></i></div>
                <div class="card-details">
                    <div><p class="c-label">Recompensa</p><p class="c-val">250 Kz</p></div>
                    <div><p class="c-label">Tipo</p><p class="c-val">Vídeo</p></div>
                </div>
            </div>
            <button class="btn-action" onclick="completeTask(250)">Ir para tarefa</button>
        </div>
    </div>
    <div id="tarefas-concluidas" class="hidden">
        <p style="text-align: center; padding: 20px; color: #fff;">Nenhuma tarefa concluída.</p>
    </div>
</div>

<div id="pg-call-center" class="view page-finance hidden">
    <div class="finance-header" onclick="showPage('pg-lar')"><i class="fa-solid fa-chevron-left"></i> Suporte</div>
    <div class="finance-body">
        <div class="chat-container" style="background: #fff; border-radius: 12px; display: flex; flex-direction: column; height: 70vh;">
            <div class="chat-messages" id="chat-messages" style="flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px;">
                <p style="text-align: center; color: #888; font-size: 11px;">Olá! Como podemos ajudar hoje?</p>
            </div>
          <div class="chat-input" style="display: flex; gap: 10px; flex-wrap: wrap;">
    <input type="text" id="mensagem-suporte" placeholder="Mensagem..." style="flex: 1; padding: 10px; border-radius: 8px;">
    
    <label for="suporte-img" style="background: #555; color: white; padding: 10px; border-radius: 8px; cursor: pointer;">
        <i class="fa-solid fa-camera"></i>
    </label>
    <input type="file" id="suporte-img" accept="image/*" style="display: none;" onchange="enviarImagemSuporte(this)">
    
    <button class="btn-send" onclick="enviarMensagemSuporte()" style="background: #6a3ab2; color: white; border: none; padding: 10px 15px; border-radius: 8px;">
        <i class="fa-solid fa-paper-plane"></i>
    </button>
</div>
        </div>
    </div>
</div>

<div id="pg-equipe" class="view hidden">
    <div class="finance-header" onclick="showPage('pg-lar')">
        <i class="fa-solid fa-chevron-left"></i> Minha Equipa
    </div>
    <div class="finance-body">
        <div class="admin-card" style="background: linear-gradient(135deg, #6a3ab2, #a83279); color: white; padding: 20px; border-radius: 15px; text-align: center;">
            <i class="fa-solid fa-share-nodes" style="font-size: 30px; margin-bottom: 10px;"></i>
            <h3>Convide Amigos</h3>
            <p style="font-size: 12px; opacity: 0.9; margin-bottom: 15px;">Ganhe até 15% de comissão sobre os investimentos dos seus amigos.</p>
            
            <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                <span id="link-convite" style="font-size: 11px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-right: 10px;">https://picadji.com/reg?ref=user7721</span>
                <button onclick="copiarLink()" style="background: white; color: #6a3ab2; border: none; padding: 5px 10px; border-radius: 5px; font-weight: bold; cursor: pointer;">COPIAR</button>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px;">
            <div style="background: #fff; color: #333; padding: 15px; border-radius: 12px; text-align: center;">
                <small>Total de Amigos</small>
                <h4 id="team-size-val" style="font-size: 20px;">0</h4>
            </div>
            <div style="background: #fff; color: #333; padding: 15px; border-radius: 12px; text-align: center;">
                <small>Bónus Ganho</small>
                <h4 id="team-bonus-val" style="font-size: 20px; color: green;">0 Kz</h4>
            </div>
        </div>

        <div style="margin-top: 20px;">
            <p style="font-size: 13px; margin-bottom: 10px; color: #333;">Regras de Recompensa:</p>
            <div style="background: rgba(255,255,255,0.8); padding: 10px; border-radius: 10px; font-size: 12px; color: #333;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span>Nível 1 (Diretos)</span> <b>10%</b>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span>Nível 2</span> <b>3%</b>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>Nível 3</span> <b>2%</b>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="pg-vip" class="view hidden">
<div class="vip-card">
<div class="card-tag">VIP1</div>
<div class="card-main">
<div class="card-img" style="background:var(--primary-purple)"><i class="fa-solid fa-gem"></i></div>
<div class="card-details">
<div><p class="c-label">Preço</p><p class="c-val">5.000 Kz</p></div>
<div><p class="c-label">Diário</p><p class="c-val">500 Kz</p></div>
</div>
</div>
<button class="btn-action">Desbloquear</button>
</div>
</div>

<div id="pg-meu" class="view hidden">
    <div class="meu-balance-area">
        <p style="font-size:12px; opacity:0.8;">Balanço Total</p>
        <h2 id="user-balance" class="balance-amount" style="font-size:36px; margin:10px 0;">0</h2>
        <p style="font-size:12px;">Kwanza (Kz)</p>
    </div>

    <div class="meu-user-stripe">
        <span id="user-name">Carregando...</span>
        <span style="background:var(--accent-green); color:#000; padding:2px 10px; border-radius:15px; font-weight:bold;">VIP 0</span>
    </div>

    <div class="meu-menu-white">
        <div class="meu-menu-row" onclick="showPage('pg-recarga')"><span>Recarregar</span> <i class="fa-solid fa-chevron-right"></i></div>
        <div class="meu-menu-row" onclick="showPage('pg-retirar')"><span>Retirar</span> <i class="fa-solid fa-chevron-right"></i></div>
        
        <div class="meu-menu-row" onclick="showPage('pg-historico')">
            <span style="font-weight:bold;"><i class="fa-solid fa-clock-rotate-left"></i> Histórico de Transações</span> 
            <i class="fa-solid fa-chevron-right"></i>
        </div>

        <div class="meu-menu-row" onclick="showPage('pg-equipe')"><span>Minha Equipe</span> <i class="fa-solid fa-chevron-right"></i></div>
        <div class="meu-menu-row" onclick="showPage('pg-senha')"><span>Alterar Senha</span> <i class="fa-solid fa-chevron-right"></i></div>
        <div class="meu-menu-row" style="border:none;" onclick="logout()"><span style="color:red;">Sair</span> <i class="fa-solid fa-chevron-right"></i></div>
    </div>
</div>

<div id="pg-retirar" class="view page-finance hidden">
    <div class="finance-header" onclick="showPage('pg-lar')">
        <i class="fa-solid fa-chevron-left"></i> Levantamento
    </div>
    <div class="finance-body">
        <div class="input-group">
            <label>Valor (Kz)</label>
            <input type="number" placeholder="Mínimo 5.000" id="valor-retirada">
        </div>
        <div class="input-group">
            <label>IBAN</label>
            <input type="text" placeholder="AO06..." id="iban-retirada">
        </div>
        <div class="input-group">
            <label>Nome do Titular</label>
            <input type="text" placeholder="Nome completo" id="nome-retirada">
        </div>
        <div class="input-group">
            <label>Senha</label>
            <input type="password" placeholder="Senha" id="senha-retirada">
        </div>
        <button class="btn-confirm" onclick="confirmarRetirada()">
            <i class="fa-solid fa-money-bill-transfer"></i> Confirmar Levantamento
        </button>
    </div>
</div>
    
<div id="pg-historico" class="view page-finance hidden">
    <div class="finance-header" onclick="showPage('pg-meu')">
        <i class="fa-solid fa-chevron-left"></i> Voltar ao Meu Perfil
    </div>
    <div class="finance-body">
        <h3 style="margin-bottom: 15px; font-size: 14px; opacity: 0.7;">Registo de Atividades</h3>
        <div id="lista-transacoes">
            <div class="transaction-card" style="background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 10px; border-left: 5px solid #f1c40f; color: #333;">
                <div style="display: flex; justify-content: space-between;">
                    <span style="font-size: 12px;">Depósito via IBAN</span>
                    <b style="color: #f1c40f; font-size: 10px;">PENDENTE</b>
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                    <b style="font-size: 16px;">+ 10.000 Kz</b>
                    <span style="font-size: 11px; opacity: 0.5;">11/01/2026</span>
                </div>
            </div>
        </div>
    </div>
</div>
    
<div id="pg-recarga" class="view page-finance hidden">
    <div class="finance-header" onclick="showPage('pg-lar')">
        <i class="fa-solid fa-chevron-left"></i> Recarga de Saldo
    </div>
    
    <div class="finance-body">
        <div id="deposito-step-1">
            <div class="input-group">
                <label>Valor a depositar (Kz)</label>
                <input type="number" id="deposito-valor" placeholder="Mínimo 5.000 Kz">
            </div>

            <div class="input-group">
                <label>Selecione o seu Banco</label>
                <select id="deposito-banco" style="width: 100%; padding: 12px; border-radius: 8px; background: #fff; color: #333;">
                    <option value="BAI">BAI (Transferência/Depósito)</option>
                    <option value="BFA">BFA</option>
                    <option value="Unitel Money">Unitel Money</option>
                </select>
            </div>

            <button class="btn-confirm" onclick="avancarPagamento()">Próximo <i class="fa-solid fa-arrow-right"></i></button>
        </div>

        <div id="deposito-step-2" class="hidden">
            <div class="admin-card" style="background: #fff; color: #333; padding: 15px; border-radius: 12px;">
                <p style="font-size: 12px; font-weight: bold; color: var(--primary-purple);">Dados para Pagamento:</p>
                
                <div style="background: #f4f4f4; padding: 10px; border-radius: 8px; margin: 10px 0; display: flex; justify-content: space-between; align-items: center;">
                    <span id="iban-txt" style="font-size: 13px; font-weight: bold;">AO06 0040 0000 1234 5678 9012</span>
                    <i class="fa-solid fa-copy" onclick="copiarIBAN()" style="color: var(--primary-purple); cursor: pointer; padding: 5px;"></i>
                </div>

                <p style="font-size: 11px;">Beneficiário: <b>PicaDji Angola</b></p>
                <p style="font-size: 11px;">Valor a enviar: <b id="valor-confirmado" style="color: green;"></b></p>
            </div>

            <div class="input-group" style="margin-top: 20px;">
                <label>Anexe a Foto do Comprovativo</label>
                <input type="file" id="comprovativo-img" accept="image/*" style="background: #fff; color: #333; width: 100%; border-radius: 8px; padding: 8px;">
            </div>

            <button class="btn-confirm" onclick="finalizarDeposito()">Confirmar Envio</button>
            <button class="btn-action" style="background: none; border: 1px solid #555; color: #fff; margin-top: 10px;" onclick="voltarPasso1()">Voltar</button>
        </div>
    </div>
</div>

<div id="pg-deposito-coordenadas" class="view page-finance hidden">
    <div class="finance-header" onclick="showPage('pg-lar')"><i class="fa-solid fa-chevron-left"></i> Depósito</div>
    <div class="finance-body">
        <div class="input-group">
            <label>Valor a depositar</label>
            <input type="text" id="valor-deposito-coordenadas" disabled>
        </div>
        <div class="input-group">
            <label>Coordenadas de depósito</label>
            <div class="code-display" style="background: #fff; padding: 10px; border-radius: 8px; margin-bottom: 5px; color: #333;">
                <span>Banco: Banco Atlântico</span>
            </div>
            <div class="code-display" style="background: #fff; padding: 10px; border-radius: 8px; margin-bottom: 5px; color: #333;">
                <span>IBAN: AO06 0040 0000 1234 5678 9012</span>
            </div>
            <div class="code-display" style="background: #fff; padding: 10px; border-radius: 8px; margin-bottom: 5px; color: #333;">
                <span>Titular: ZEROmallS</span>
            </div>
        </div>
        <button class="btn-confirm" onclick="toast('Depósito em análise!')">Confirmar Depósito</button>
    </div>
</div>

<div id="pg-senha" class="view page-finance hidden">
    <div class="finance-header" onclick="showPage('pg-meu')"><i class="fa-solid fa-chevron-left"></i> Alterar Senha</div>
    <div class="finance-body">
        <div class="input-group"><label>Senha Atual</label><input type="password"></div>
        <div class="input-group"><label>Nova Senha</label><input type="password"></div>
        <button class="btn-confirm" onclick="toast('Senha alterada!')">Atualizar</button>
    </div>
</div>

<nav class="bottom-nav">
<div class="nav-tab active" onclick="showPage('pg-lar', this)"><i class="fa-solid fa-house"></i><span>Lar</span></div>
<div class="nav-tab" onclick="showPage('pg-tarefa', this)"><i class="fa-solid fa-list-check"></i><span>Tarefa</span></div>
<div class="nav-tab" onclick="showPage('pg-equipe', this)"><i class="fa-solid fa-users"></i><span>Equipe</span></div>
<div class="nav-tab" onclick="showPage('pg-vip', this)"><i class="fa-solid fa-crown"></i><span>VIP</span></div>
<div class="nav-tab" onclick="showPage('pg-meu', this)"><i class="fa-solid fa-user"></i><span>Meu</span></div>
</nav>
</div>

<script>
const API_URL = "https://warnermida-1.onrender.com";
const IMGBB_KEY = "f1cbde38d1820926fd47faeb3e74975f"; // Chave extraída do seu código

// --- CONTROLE DE NAVEGAÇÃO ---
function showPage(id, el) {
    document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
    const target = document.getElementById(id);
    if(target) target.classList.remove('hidden');

    const header = document.getElementById('main-header');
    const mains = ['pg-lar', 'pg-tarefa', 'pg-meu', 'pg-vip', 'pg-equipe'];
    header.style.display = mains.includes(id) ? 'flex' : 'none';

    if(el) {
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        el.classList.add('active');
    }
    window.scrollTo(0,0);
    
    // Se abrir a página de equipe, sincroniza os dados dela
    if(id === 'pg-equipe') sincronizarDados();
}

// --- SINCRONIZAÇÃO DE DADOS (Unificada) ---
async function sincronizarDados() {
    try {
        const storageData = localStorage.getItem('user') || localStorage.getItem('usuario');
        if (!storageData) return;
        const user = JSON.parse(storageData);
        const userId = user.id || user._id;

        // 1. Atualiza dados do usuário (Saldo e Nome)
        const resUser = await fetch(`${API_URL}/api/usuario/${userId}`);
        if (resUser.ok) {
            const dadosNovos = await resUser.json();
            // Mantém o objeto atualizado no storage
            localStorage.setItem('usuario', JSON.stringify(dadosNovos));
            
            // Atualiza elementos na tela (se existirem)
            const bal = document.getElementById('user-balance');
            const nom = document.getElementById('user-name');
            if(bal) bal.innerText = `${dadosNovos.saldo} Kz`;
            if(nom) nom.innerText = dadosNovos.nome;
            
            // ATUALIZA O LINK DE CONVITE
            const linkEl = document.getElementById('link-convite');
            if (linkEl && dadosNovos.referral_id) {
                linkEl.innerText = `https://warnermidia.netlify.app/registro.html?ref=${dadosNovos.referral_id}`;
            }

            // 2. BUSCA DADOS DA EQUIPE
            if(dadosNovos.referral_id) {
                const resEquipe = await fetch(`${API_URL}/api/equipe/${dadosNovos.referral_id}`);
                if (resEquipe.ok) {
                    const equipe = await resEquipe.json();
                    const sizeEl = document.getElementById('team-size-val');
                    const bonusEl = document.getElementById('team-bonus-val');
                    if(sizeEl) sizeEl.innerText = equipe.teamCount;
                    if(bonusEl) bonusEl.innerText = equipe.teamBonus + " Kz";
                }
            }
        }
    } catch (err) {
        console.warn("Sincronização pendente ou erro de rede.");
    }
}
// --- SISTEMA DE SUPORTE REAL ---

// Carregar histórico quando abrir a página de suporte
async function carregarHistoricoSuporte() {
    const storageData = localStorage.getItem('user') || localStorage.getItem('usuario');
    const user = JSON.parse(storageData);
    const userId = user.id || user._id;

    try {
        const res = await fetch(`${API_URL}/api/suporte/historico/${userId}`);
        const mensagens = await res.json();
        const box = document.getElementById('chat-messages');
        box.innerHTML = "";

        mensagens.forEach(m => {
            const isMe = m.enviado_por === 'usuario';
            const align = isMe ? 'flex-end' : 'flex-start';
            const bg = isMe ? '#6a3ab2' : '#f1f1f1';
            const color = isMe ? '#fff' : '#333';
            const radius = isMe ? '12px 12px 0 12px' : '12px 12px 12px 0';

            box.innerHTML += `
                <div style="align-self: ${align}; background: ${bg}; color: ${color}; padding: 10px 15px; border-radius: ${radius}; max-width: 80%; font-size: 13px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                    ${m.mensagem}
                    <div style="font-size: 9px; opacity: 0.6; margin-top: 5px; text-align: right;">
                        ${new Date(m.data).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                    </div>
                </div>`;
        });
        box.scrollTop = box.scrollHeight;
    } catch (err) {
        console.error("Erro ao carregar chat");
    }
}
 async function confirmarRetirada() {
    const valor = document.getElementById('valor-retirada').value;
    const iban = document.getElementById('iban-retirada').value;
    const titular = document.getElementById('nome-retirada').value;
    const senha = document.getElementById('senha-retirada').value;

    const storageData = localStorage.getItem('user') || localStorage.getItem('usuario');
    const user = JSON.parse(storageData);

    // Validações básicas no front-end
    if (!valor || valor < 5000) return toast("❌ O valor mínimo é 5.000 Kz");
    if (iban.length < 10) return toast("❌ Insira um IBAN válido");
    if (!titular) return toast("❌ Insira o nome do titular");
    if (!senha) return toast("❌ Insira sua senha");

    toast("Processando pedido...");

    try {
        const res = await fetch(`${API_URL}/api/levantamento`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                usuario_id: user.id || user._id,
                valor: parseFloat(valor),
                iban: iban,
                nome_titular: titular,
                senha: senha
            })
        });

        // IMPORTANTE: Aqui pegamos a resposta do servidor (mesmo que seja erro)
        const data = await res.json();

        if (!res.ok) {
            // Se o servidor retornar 400 (Saldo insuficiente), ele cai aqui
            // E mostra exatamente a mensagem "Saldo insuficiente" no toast
            return toast("❌ " + (data.error || "Erro ao processar"));
        }

        // Se deu tudo certo (Res 200/201)
        toast("✅ Pedido de levantamento enviado!");
        document.getElementById('valor-retirada').value = "";
        sincronizarDados();
        setTimeout(() => showPage('pg-lar'), 2000);

    } catch (err) {
        toast("❌ Erro de conexão com o servidor.");
        console.error("Erro completo:", err);
    }
}
async function enviarMensagemSuporte() {
    const input = document.getElementById('mensagem-suporte');
    const msg = input.value.trim();
    const storageData = localStorage.getItem('user') || localStorage.getItem('usuario');
    const user = JSON.parse(storageData);

    if (!msg) return;

    try {
        const res = await fetch(`${API_URL}/api/suporte/enviar`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                usuario_id: user.id || user._id,
                enviado_por: 'usuario',
                mensagem: msg
            })
        });

        if (res.ok) {
            input.value = "";
            carregarHistoricoSuporte(); // Atualiza a tela
        }
    } catch (err) {
        toast("Erro ao enviar mensagem.");
    }
}

// Atualizar a função showPage para carregar o chat quando abrir o suporte
const originalShowPage = showPage;
showPage = function(id, el) {
    originalShowPage(id, el);
    if (id === 'pg-call-center') {
        carregarHistoricoSuporte();
        // Opcional: Atualizar o chat a cada 5 segundos enquanto estiver na página
        window.chatInterval = setInterval(carregarHistoricoSuporte, 5000);
    } else {
        clearInterval(window.chatInterval);
    }
}

    // Função para o usuário enviar foto no chat de suporte
async function enviarImagemSuporte(input) {
    if (!input.files || !input.files[0]) return;

    const storageData = localStorage.getItem('user') || localStorage.getItem('usuario');
    const user = JSON.parse(storageData);
    const userId = user.id || user._id;

    toast("Hospedando imagem...");
    const formData = new FormData();
    formData.append("image", input.files[0]);

    try {
        // 1. Envia para o ImgBB
        const resImg = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, {
            method: "POST",
            body: formData
        });
        const dataImg = await resImg.json();

        if (dataImg.success) {
            const urlImagem = dataImg.data.url;
            
            // 2. Envia a tag HTML da imagem como mensagem para o banco
            const resChat = await fetch(`${API_URL}/api/suporte/enviar`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    usuario_id: userId,
                    enviado_por: 'usuario',
                    // Enviamos a tag IMG formatada para o chat exibir direto
                    mensagem: `<img src="${urlImagem}" style="max-width:100%; border-radius:10px; display:block; margin:5px 0;">`
                })
            });

            if (resChat.ok) {
                toast("Foto enviada!");
                carregarHistoricoSuporte();
            }
        }
    } catch (err) {
        toast("Erro ao enviar foto.");
        console.error(err);
    }
}
// --- FUNÇÕES DE INTERAÇÃO ---
function copiarLink() {
    const linkEl = document.getElementById('link-convite');
    if(!linkEl) return;
    const link = linkEl.innerText;
    navigator.clipboard.writeText(link).then(() => {
        toast("✅ Link de convite copiado!");
    });
}

async function finalizarDeposito() {
    const valorInput = document.getElementById('deposito-valor');
    const imgInput = document.getElementById('comprovativo-img');
    const storageData = localStorage.getItem('user') || localStorage.getItem('usuario');
    const user = JSON.parse(storageData);

    if (!imgInput.files || imgInput.files.length === 0) return toast("Selecione a foto!");
    if (!valorInput.value || valorInput.value < 5000) return toast("Mínimo: 5.000 Kz");

    toast("Hospedando imagem...");
    const formData = new FormData();
    formData.append("image", imgInput.files[0]);

    try {
        const resImg = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, {
            method: "POST",
            body: formData
        });
        const dataImg = await resImg.json();

        if (dataImg.success) {
            const resFinal = await fetch(`${API_URL}/api/deposito`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    usuario_id: user.id || user._id,
                    valor: valorInput.value,
                    comprovativo: dataImg.data.url
                })
            });
            if (resFinal.ok) {
                toast("✅ Enviado para análise!");
                showPage('pg-lar');
                voltarPasso1();
            }
        } else {
            toast("Erro ao carregar imagem.");
        }
    } catch (err) { toast("Erro de conexão."); }
}

async function completeTask(val) {
    const user = JSON.parse(localStorage.getItem('user') || localStorage.getItem('usuario'));
    if (!user) return toast("Faça login");
    
    toast("Processando...");
    try {
        const res = await fetch(`${API_URL}/api/completar-tarefa`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ usuario_id: user.id || user._id, valor: val })
        });
        if(res.ok) {
            toast('Tarefa Concluída! +' + val + ' Kz');
            sincronizarDados();
        }
    } catch(e) { toast("Erro ao salvar"); }
}

// --- UTILITÁRIOS ---
function logout() {
    localStorage.clear();
    window.location.href = 'login.html';
}

function toast(msg) {
    const t = document.createElement('div');
    t.style = "position:fixed; bottom:100px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.85); color:#fff; padding:12px 20px; border-radius:25px; font-size:12px; z-index:9999; text-align:center; min-width:200px;";
    t.innerText = msg;
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 2500);
}

function copiarIBAN() {
    navigator.clipboard.writeText(document.getElementById('iban-txt').innerText);
    toast("IBAN copiado!");
}

function avancarPagamento() {
    const v = document.getElementById('deposito-valor').value;
    if (v < 5000) return toast("Mínimo 5.000 Kz");
    document.getElementById('valor-confirmado').innerText = v + " Kz";
    document.getElementById('deposito-step-1').classList.add('hidden');
    document.getElementById('deposito-step-2').classList.remove('hidden');
}

function voltarPasso1() {
    document.getElementById('deposito-step-2').classList.add('hidden');
    document.getElementById('deposito-step-1').classList.remove('hidden');
}

window.addEventListener('load', () => {
    if (!(localStorage.getItem('user') || localStorage.getItem('usuario'))) {
        window.location.href = 'login.html';
    } else {
        sincronizarDados();
    }
});
</script>
</body>
</html>
